sudo: required
language: go
services:
  - docker

cache:
  directories:
  # We cache the SDK so we don't have to download it again on subsequent builds.
  - $HOME/google-cloud-sdk

env:
  global:
  # Do not prompt for user input when using any SDK methods.
  - CLOUDSDK_CORE_DISABLE_PROMPTS=1
  # Needed to install deps
  - GO111MODULE=on
  # Commit SHA
  - SHA=$(git rev-parse HEAD)

before_install:
    # Install google cli and kubectl

    # The install script errors if this directory already exists,
    # but Travis already creates it when we mark it as cached.
  - if [ ! -d $HOME/google-cloud-sdk/bin ]; then rm -rf $HOME/google-cloud-sdk; curl https://sdk.cloud.google.com | bash > /dev/null; fi
  - source $HOME/google-cloud-sdk/path.bash.inc
  - gcloud components update kubectl
  - gcloud version

  # Authorize google cli
  - openssl aes-256-cbc -K $encrypted_0c35eebf403c_key -iv $encrypted_0c35eebf403c_iv -in build/assets/service-account.json.enc -out build/assets/service-account.json -d
  - gcloud auth activate-service-account --key-file build/assets/service-account.json

  # Config project settings
  - gcloud config set project fib-overkill
  - gcloud config set compute/zone us-central1-a
  - gcloud container clusters get-credentials fib-overkill-cluster

  # Log into dockhub using travis env var
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # Build dev docker image for testing
  - docker build -t dnilosek/fib-overkill-web-test -f ./web/dockerfile.dev ./web

script:
  # Run tests
  - docker run -e CI=true dnilosek/fib-overkill-web-test npm test
  - make dep && make test

# Deploy images to Dockerhub and to K8s cluster
deploy:
  provider: script
  script: bash ./build/travis/deploy.sh
  on:
    branch: master
